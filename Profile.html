<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile</title>
<link rel="stylesheet" href="styles.css">
<style>
  body {
      background: url('Mega%20Speedruns_files/bg.png') no-repeat center center fixed;
      background-size: cover;
  }
</style>
<link rel="shortcut icon" type="image/x-icon" href="Mega%20Speedruns_files/logo.png" />
</head>

<body>
<header>
    <div class="logo">
        <img src="Mega%20Speedruns_files/logo.png" alt="Logo">
    </div>
        <nav class="nav-wrapper">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="MSTLP.htm">Level Packs</a></li>
                <li><a href="MMMLevels.htm">MMM Levels</a></li>
                <li><a href="Speedruns.htm">Speedruns</a></li>
                <li><a id="Forums" href="Forum.html">Forums</a></ali>
                <li><a id="login" href="Login.html">Login</a></li>
                <li><a href="Users.html">Users</a></li>
            </ul>
        </nav>
</header>

<div class="shadow">
  <div class="profile-left">
    <img id="profile-img" src="Mega%20Speedruns_files/Default_Avatar.png" alt="Profile Image">
    <input type="text" class = "img-input" id="url-input" placeholder="Paste image URL here">
    <button class = "button" id="url-btn">Set Image</button>
  </div>

  <div class="profile-right">
    <div class="profile-header">
      <h1 id="profile">User Profile</h1>
      <div id="color-picker-container" style="margin-top: 10px; display: none;">
      <label for="username-color" style="font-weight: bold;">Username Color:</label>
      <input type="color" id="username-color" value="#FFFFFF"; cursor: pointer;>
      <button class="button" id="save-color-btn">Save</button>
      <button class= "button" id="logout-btn"  style="height: 35px;">Logout</button>
    </div>
    </div>
    <div id="user-info"></div>
    <div id="user-runs"></div>
  </div>
</div>

  <div class="shadow-box">
  <div class="Spacing">
      <ul id="userSpeedruns"></ul>
  </div>
  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  get,
  set,
  child
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC2pHhSThFkKhN-c1sdhUATt1-zmNLV9sw",
  authDomain: "megaspeedrunsdatabase.firebaseapp.com",
  databaseURL: "https://megaspeedrunsdatabase-default-rtdb.firebaseio.com",
  projectId: "megaspeedrunsdatabase",
  storageBucket: "megaspeedrunsdatabase.appspot.com",
  messagingSenderId: "545413984550",
  appId: "1:545413984550:web:79c899026a21f6343091e7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const userProfile = document.getElementById("profile");
const profileImg = document.getElementById("profile-img");
const userInfoDiv = document.getElementById("user-info");
const urlInput = document.getElementById("url-input");
const urlBtn = document.getElementById("url-btn");
const loginLink = document.getElementById("login");
const logoutBtn = document.getElementById("logout-btn");

const runsContainer = document.createElement("div");
const runCountEl = document.createElement("h3");
runCountEl.className = "outline";
const userRunsList = document.createElement("ul");
runsContainer.appendChild(runCountEl);
runsContainer.appendChild(userRunsList);
document.querySelector(".shadow-box").appendChild(runsContainer);

const urlSetImage = (url) => {
  if (!url) return alert("Enter a valid image URL!");
  profileImg.src = url;
  const user = auth.currentUser;
  if (user) {
    const uidToView = new URLSearchParams(window.location.search).get("uid") || user.uid;
    if (uidToView === user.uid) {
      set(ref(db, "users/" + user.uid + "/profileImageURL"), url)
        .then(() => console.log("URL saved to database"))
        .catch(err => console.error("Failed to save URL:", err));
    }
  }
};

urlBtn.addEventListener("click", () => urlSetImage(urlInput.value.trim()));
urlInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") urlSetImage(urlInput.value.trim());
});

function linkify(text) {
  const urlPattern = /(\bhttps?:\/\/[^\s]+)/gi;
  return text.replace(urlPattern, '<a href="$1" target="_blank">$1</a>');
}

const urlParams = new URLSearchParams(window.location.search);
const profileUidFromUrl = urlParams.get("uid");

onAuthStateChanged(auth, async (user) => {
  const urlParams = new URLSearchParams(window.location.search);
  const uidToView = urlParams.get("uid");

  // Update login/logout links
  if (user) {
    loginLink.innerText = "Profile";
    loginLink.href = `Profile.html?uid=${user.uid}`;
    logoutBtn.style.display = "inline-block";
  } else {
    loginLink.innerText = "Login";
    loginLink.href = "Login.html";
    logoutBtn.style.display = "none";
  }

  // If no ?uid= in the URL, show logged-in user's profile (if available)
  if (!uidToView && user) {
    const newUrl = `${window.location.pathname}?uid=${user.uid}`;
    window.history.replaceState({}, "", newUrl);
  }

  // If still no UID, stop â€” can't load any profile
  const profileUid = urlParams.get("uid") || (user ? user.uid : null);
  if (!profileUid) {
    userProfile.innerText = "No profile selected.";
    return;
  }

  try {
    // === FETCH PROFILE DATA ===
    const snapshot = await get(ref(db, "users/" + profileUid));
    const userData = snapshot.val();

    if (!userData) {
      userProfile.innerText = "User not found";
      userInfoDiv.innerHTML = "";
      return;
    }

    // === DISPLAY PROFILE HEADER ===
    const usernameColor = userData.usernameColor || "#FFFFFF";
    userProfile.innerHTML = `<p style="color:${usernameColor}">${userData.username}'s Profile</p><br>`;

    // === UPDATE PROFILE IMAGE ===
    if (userData.profileImageURL) {
      profileImg.src = userData.profileImageURL + "?t=" + new Date().getTime();
    }

    // === DISPLAY BIO ===
    userInfoDiv.innerHTML = `<p id="bio-text">${userData.bio ? userData.bio.replace(/\n/g, "<br>") : ""}</p><br>`;

    // === SHOW EDIT OPTIONS ONLY IF VIEWING OWN PROFILE ===
    if (user && profileUid === user.uid) {
      colorPickerContainer.style.display = "block";
      usernameColorInput.value = usernameColor;

      saveColorBtn.onclick = async () => {
        await set(ref(db, "users/" + user.uid + "/usernameColor"), usernameColorInput.value);
        userProfile.innerHTML = `<p style="color:${usernameColorInput.value}">${userData.username}'s Profile</p><br>`;
      };

      // Allow bio editing
      const bioInput = document.createElement("textarea");
      bioInput.id = "bio-input";
      bioInput.style.width = "100%";
      bioInput.style.height = "60px";
      bioInput.value = userData.bio || "";
      bioInput.className = "bio-input";
      bioInput.style.display = "none";
      userInfoDiv.appendChild(bioInput);

      const bioBtn = document.createElement("button");
      bioBtn.className = "button";
      bioBtn.id = "bio-btn";
      bioBtn.innerText = "Edit Profile";
      userInfoDiv.appendChild(bioBtn);

      const bioText = document.getElementById("bio-text");
      bioBtn.addEventListener("click", async () => {
        if (bioBtn.innerText === "Edit Profile") {
          bioInput.style.display = "block";
          bioBtn.innerText = "Save";
        } else {
          const newBio = bioInput.value.trim();
          await set(ref(db, "users/" + user.uid + "/bio"), newBio);
          bioText.innerHTML = newBio ? newBio.replace(/\n/g, "<br>") : "No bio set.";
          bioInput.style.display = "none";
          bioBtn.innerText = "Edit Profile";
        }
      });
    } else {
      colorPickerContainer.style.display = "none";
      urlInput.style.display = "none";
      urlBtn.style.display = "none";
    }

    // === FETCH USER SPEEDRUNS ===
    const dbRef = ref(db);
    const speedrunSnapshot = await get(child(dbRef, "SpeedRunner/"));

    if (speedrunSnapshot.exists()) {
      const data = speedrunSnapshot.val();
      const totalRuns = Number(data.RunNum) || 0;
      let matchCount = 0;

      const loggedInUser = (userData.username || "").replace(/_/g, " ").trim().toLowerCase();
      const userNickname = (userData.nickname || "").replace(/_/g, " ").trim().toLowerCase();

      userRunsList.innerHTML = "";

      for (let i = 1; i <= totalRuns; i++) {
        const runData = data[i];
        if (!runData) continue;

        const runnerName = (runData.Runner || "").replace(/_/g, " ").trim().toLowerCase();
        if (runnerName === loggedInUser || runnerName === userNickname) {
          matchCount++;

          const list = document.createElement("li");
          list.setAttribute("class", "spacing");

          const level = runData.Run.replace(/_/g, " ");
          const time = runData.Time.replace(/^0+:?/, "").replace(/^0+/, "");
          const link = runData.Link;
          const tournament = runData.Tournament;
          const levelLabel = level.includes("Week") ? "LevelPack" : "Level";

          list.innerHTML = `
            <img src="Mega%20Speedruns_files/${tournament}SS/${runData.Run}.png" alt="${level}" class="imgResize">
            <span>${levelLabel}: ${level}</span>
            <span>Time: ${time}</span>
            <span><a href="${link}" target="_blank">Watch Run</a></span>
          `;

          userRunsList.appendChild(list);
        }
      }

      runCountEl.innerText = `Speedruns - Runs Submitted: ${matchCount}`;
    } else {
      runCountEl.innerText = "Speedruns - Runs Submitted: 0";
    }
  } catch (err) {
    console.error("Failed to load profile:", err);
  }
});


logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "Login.html";
  } catch (err) {
    console.error("Logout failed:", err);
    alert("Failed to log out. Try again.");
  }
});

profileImg.onerror = () => {
    profileImg.src = 'Mega Speedruns_files/Default_Avatar.png';
};
</script>

<script>
window.addEventListener("DOMContentLoaded", () => {
    const loginEl = document.getElementById("login");
    const cachedUsername = localStorage.getItem("username");
    if (cachedUsername) {
        loginEl.textContent = `Profile`;
        loginEl.href = "Profile.html";
    } else {
        loginEl.textContent = "Login";
        loginEl.href = "Login.html";
    }
});

const usernameColorInput = document.getElementById("username-color");
const saveColorBtn = document.getElementById("save-color-btn");
const colorPickerContainer = document.getElementById("color-picker-container");
</script>

</body>
</html>
