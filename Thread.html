<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Thread</title>
<link rel="stylesheet" href="styles.css">
<style>
    body {
        background: url('Mega%20Speedruns_files/bg.png') no-repeat center center fixed;
        background-size: cover;
        font-family: Arial, sans-serif;
        color: #fff;
        margin: 0;
        padding: 0;
    }

    main {
        max-width: 60%;
        margin: 40px auto;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    h1 {
        color: #ffcc00;
        margin-bottom: 10px;
    }

    .post {
        background-color: rgba(40, 40, 40, 0.8);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .post-author {
        font-weight: bold;
    }

    .replies {
        margin-top: 20px;
    }

    .reply {
        background-color: rgba(30, 30, 30, 0.8);
        padding: 10px;
        margin-top: 10px;
        border-radius: 6px;
    }

    .reply-box {
        display: none;
        margin-top: 15px;
    }

    .input {
        width: 95%;
        padding: 10px;
        border-radius: 6px;
        border: none;
        background-color: #222;
        color: #fff;
        margin-bottom: 10px;
    }

    button {
        padding: 10px 15px;
        background-color: blue;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
    }

    button:hover {
        background-color: #00b8d9;
    }

    #login-warning {
        color: #ff5555;
        font-weight: bold;
        text-align: center;
        margin-top: 20px;
    }
</style>
</head>
<body>
    <header>
        <nav class="nav-wrapper">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="MSTLP.htm">Level Packs</a></li>
                <li><a href="MMMLevels.htm">MMM Levels</a></li>
                <li><a href="Speedruns.htm">Speedruns</a></li>
                <li><a id="Forums" href="Forum.html">Forums</a></ali>
                <li><a id="login" href="Login.html">Login</a></li>
                <li><a href="Users.html">Users</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h1 id="thread-title">Loading...</h1>
        <div class="post">
            <div class="post-author" id="thread-author"></div>
            <p id="thread-content"></p>
        </div>

        <div class="replies" id="replies"></div>

        <div id="reply-box" class="reply-box">
            <textarea id="reply-input" class="input" rows="3" placeholder="Write your reply..."></textarea>
            <button onclick="postReply()">Post Reply</button>
        </div>

        <div id="login-warning" style="display: none;">
            Please log in to reply to this thread.
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="auth.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const category = params.get("category");
    const threadId = params.get("id");
    const titleEl = document.getElementById("thread-title");
    const authorEl = document.getElementById("thread-author");
    const contentEl = document.getElementById("thread-content");
    const repliesEl = document.getElementById("replies");
    const replyBox = document.getElementById("reply-box");
    const loginWarning = document.getElementById("login-warning");

let currentUser = null;

auth.onAuthStateChanged((user) => {
    currentUser = user;
    if (user) {
        replyBox.style.display = "block";
        loginWarning.style.display = "none";
    } else {
        replyBox.style.display = "none";
        loginWarning.style.display = "block";
    }
});

async function getUsernameColor(username) {
    if (!username) {
        console.warn("No username provided to getUsernameColor");
        return "#00e6ff"; // Fallback color
    }

    try {
        // Search for a user where username matches
        const snapshot = await db.ref("users")
            .orderByChild("username")
            .equalTo(username)
            .once("value");

        if (!snapshot.exists()) {
            console.warn(`No user found with username: ${username}`);
            return "#00e6ff"; // Default fallback
        }

        let color = "#00e6ff"; // Default if missing

        snapshot.forEach(child => {
            const data = child.val();
            if (data.usernameColor) {
                color = data.usernameColor.startsWith("#") 
                    ? data.usernameColor 
                    : `#${data.usernameColor}`;
            }
        });

        return color;

    } catch (error) {
        console.error("Error fetching username color:", error);
        return "#00e6ff"; // Fallback on error
    }
}

async function loadThread() {
    const snapshot = await db.ref(`forum/${category}/${threadId}`).once("value");
    const data = snapshot.val();
    titleEl.textContent = data.title;

    // Get the author's chosen username color
    const color = await getUsernameColor(data.author);
    console.log("Author:", data.author);
    console.log("Fetched color:", color);
    authorEl.innerHTML = `Posted by <span style="color:${color}; font-weight:bold;">${data.author}</span>`;

    // Show delete button if current user's username matches thread author
    const currentUsername = localStorage.getItem("username");
if (currentUsername && currentUsername === data.author) {
    const deleteThreadBtn = document.createElement("button");
    deleteThreadBtn.textContent = "x";

    // Style as small dark grey button
    deleteThreadBtn.style.float = "right";           // Push to the right
    deleteThreadBtn.style.backgroundColor = "#444";  // Dark grey
    deleteThreadBtn.style.color = "#fff";            // White text
    deleteThreadBtn.style.padding = "5px 10px";      // Compact padding
    deleteThreadBtn.style.fontSize = "0.85rem";      // Small text
    deleteThreadBtn.style.height = "28px";           // Short height
    deleteThreadBtn.style.borderRadius = "4px";      // Rounded corners
    deleteThreadBtn.style.border = "none";           // Remove border
    deleteThreadBtn.style.cursor = "pointer";        // Pointer on hover

    // Optional hover effect
    deleteThreadBtn.onmouseover = () => deleteThreadBtn.style.backgroundColor = "#666";
    deleteThreadBtn.onmouseout = () => deleteThreadBtn.style.backgroundColor = "#444";

    deleteThreadBtn.onclick = async () => {
        const confirmDelete = confirm("Are you sure you want to delete this thread?");
        if (!confirmDelete) return;
        try {
            await db.ref(`forum/${category}/${threadId}`).remove();
            alert("Thread deleted successfully.");
            window.location.href = "Forum.html"; // Redirect back to forum
        } catch (err) {
            console.error("Failed to delete thread:", err);
            alert("Failed to delete thread. Try again.");
        }
    };

    authorEl.appendChild(deleteThreadBtn);
}

    contentEl.textContent = data.content;
    loadReplies();
}

async function loadReplies() {
    repliesEl.innerHTML = "<h2>Replies</h2>";

    const snapshot = await db.ref(`forum/${category}/${threadId}/replies`).once("value");
    const replies = [];

    snapshot.forEach(child => {
        replies.push({ ...child.val(), key: child.key }); // Keep Firebase key for deletion
    });

    // Sort replies by timestamp
    replies.sort((a, b) => a.timestamp - b.timestamp);

    for (const reply of replies) {
        const color = await getUsernameColor(reply.author);

        const div = document.createElement("div");
        div.classList.add("reply");
        div.style.position = "relative"; // Needed for absolute positioning if desired
        div.innerHTML = `<strong style="color:${color}">${reply.author}</strong>: ${reply.content}`;

        // Show delete button if current user's username matches reply author
        const currentUsername = localStorage.getItem("username");
        if (currentUsername && currentUsername === reply.author) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "x";

            // Small dark grey style
            delBtn.style.float = "right";
            delBtn.style.backgroundColor = "#444";
            delBtn.style.color = "#fff";
            delBtn.style.padding = "3px 8px";
            delBtn.style.fontSize = "0.75rem";
            delBtn.style.height = "24px";
            delBtn.style.borderRadius = "4px";
            delBtn.style.border = "none";
            delBtn.style.cursor = "pointer";

            // Hover effect
            delBtn.onmouseover = () => delBtn.style.backgroundColor = "#666";
            delBtn.onmouseout = () => delBtn.style.backgroundColor = "#444";

            delBtn.onclick = async () => {
                const confirmDelete = confirm("Are you sure you want to delete this reply?");
                if (!confirmDelete) return;
                try {
                    await db.ref(`forum/${category}/${threadId}/replies/${reply.key}`).remove();
                    loadReplies(); // Refresh replies
                } catch (err) {
                    console.error("Failed to delete reply:", err);
                    alert("Failed to delete reply. Try again.");
                }
            };

            div.appendChild(delBtn);
        }

        repliesEl.appendChild(div);
    }
}

async function postReply() {
    if (!currentUser) return;

    const input = document.getElementById("reply-input");
    const content = input.value.trim();
    if (!content) return;

    const replyRef = db.ref(`forum/${category}/${threadId}/replies`).push();
    await replyRef.set({
        author: localStorage.getItem("username"),
        authorUID: currentUser.uid,
        content,
        timestamp: Date.now()
    });

    input.value = "";
    loadReplies();
}

loadThread();
</script>


    <script>
    window.addEventListener("DOMContentLoaded", () => {
        const loginEl = document.getElementById("login");
        const cachedUsername = localStorage.getItem("username");
        if (cachedUsername) {
            loginEl.textContent = `Profile`;
            loginEl.href = "Profile.html";
        } else {
            loginEl.textContent = "Login";
            loginEl.href = "Login.html";
        }
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const snapshot = await db.ref("users/" + user.uid).once("value");
                    const username = snapshot.val()?.username || "Login";
                    loginEl.textContent = `Profile`;
                    loginEl.href = "Profile.html";
                    localStorage.setItem("username", username);
                } catch (err) {
                    console.error("Failed to fetch username:", err);
                    loginEl.textContent = "Login";
                    loginEl.href = "Login.html";
                }
            } else {
                loginEl.textContent = "Login";
                loginEl.href = "Login.html";
                localStorage.removeItem("username");
            }
        });
    });
    </script>

</body>
</html>
