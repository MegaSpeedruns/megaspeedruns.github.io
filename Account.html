<!DOCTYPE html>
<html lang="en"> 
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Speedruns</title>
    <link rel="stylesheet" href="Mega%20Speedruns_files/styles.css">
    <style>
      body {
          background: url('Mega%20Speedruns_files/bg.png') no-repeat center center fixed;
          background-size: cover;
      }
  </style>
  <main>
    <div class="box-shadow">
      
    </div>
    <body>
      <header>
        <div class="logo">
        <img src="Mega%20Speedruns_files/logo.png" alt="Logo">
        <link rel="shortcut icon" type="image/x-icon" href="Mega%20Speedruns_files/logo.png" />              
        </div>
        <nav class="nav-wrapper">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="MSTLP.htm">MMM Level Packs</a></li>
            <li><a href="MSTLevels.htm">MST Levels</a></li>
            <li><a href="Speedruns.htm">Speedruns</a></li>
            <li><a href="Account.html">Account</a></li>
            <li><a href="Login.html">Login</a></li>
        </ul>
        </nav>
      </header>
      <div class= "signup-link" id="statusMessage"></div>
    </body>
  </main>

<script type="module">
    import './index.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC2pHhSThFkKhN-c1sdhUATt1-zmNLV9sw",
        authDomain: "megaspeedrunsdatabase.firebaseapp.com",
        projectId: "megaspeedrunsdatabase",
        storageBucket: "megaspeedrunsdatabase.appspot.com",
        messagingSenderId: "545413984550",
        appId: "1:545413984550:web:79c899026a21f6343091e7"
    };

    const app = initializeApp(firebaseConfig);

    //import { getAuth, createUserWithEmailAndPassword } from "firebase/auth";
    import { getDatabase, ref, child, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const db = getDatabase();

    let signupUsername = document.getElementById('signupUsername');
    let signupPassword = document.getElementById('signupUsername');
    let loginUsername = document.getElementById('loginUsername');
    let loginPassword = document.getElementById('loginUsername');

    let AddBtn = document.getElementById('AddBtn');
    let RetBtn = document.getElementById('RetBtn');
    let UpdBtn = document.getElementById('UpdBtn');
    let DelBtn = document.getElementById('DelBtn');

    var x = "0";
    var i = "0";

    //New data
  {
    const loginText = document.querySelector(".title-text .login");
    const loginForm = document.querySelector("form.login");
    const loginBtn = document.querySelector("label.login");
    const signupBtn = document.querySelector("label.signup");
    const signupLink = document.querySelector("form .signup-link a");
  }

// Function to handle signup
function handleSignup() {
        const username = document.getElementById('signupUsername').value;
        const password = document.getElementById('signupPassword').value;

        // You can trigger any event or logic you need when the form is submitted.
        alert(`Signup successful for username: ${username}`);

        // Store user data in Firebase Database (optional)
        const userId = new Date().getTime(); // Unique ID based on timestamp
        set(ref(db, 'Account/' + userId), {
            username: username,
            password: password,  // Storing password in plaintext is not secure; ideally, encrypt it before storing.
            createdAt: new Date().toISOString()
        }).then(() => {
            alert('User account added to the database.');
        }).catch((error) => {
            alert('Error: ' + error.message);
        });
    }

// Modify handleLogin function to update login status
function handleLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    // Query the Firebase database to find users with the provided username
    get(ref(db, 'Account/')).then((snapshot) => {
        let isAuthenticated = false;

        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                if (userData.username === username && userData.password === password) {
                    isAuthenticated = true;
                    return true; // Exit the loop once a match is found
                }
            });

            if (isAuthenticated) {
                alert('Login successful!');
                localStorage.setItem('loggedIn', 'true');
                localStorage.setItem('loggedInUser', username);
                displayLoginStatus();  // Update login status on screen
            } else {
                alert('Invalid username or password.');
                localStorage.setItem('loggedIn', 'false');
            }
        } else {
            alert('Username not found.');
            localStorage.setItem('loggedIn', 'false');
        }
    }).catch((error) => {
        alert('Error: ' + error.message);
    });
}

// Call displayLoginStatus() on page load to show the correct status
document.addEventListener('DOMContentLoaded', displayLoginStatus);

// Function to display login status
function displayLoginStatus() {
    const statusDiv = document.getElementById('statusMessage');
    const isLoggedIn = localStorage.getItem('loggedIn');
    
    if (isLoggedIn === 'true') {
        statusDiv.innerHTML = `<p>Welcome, ${localStorage.getItem('loggedInUser')}! You are logged in.</p>`;
    } else {
        statusDiv.innerHTML = `<p>You are not logged in.</p>`;
    }
}

    // Attach the handleSignup function to the signup form submission
    document.getElementById('signupForm').addEventListener('submit', function(event) {
        event.preventDefault();
        handleSignup();
    });

    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault();
        handleLogin();
    });

function AddData() {
            set(ref(db, 'Account/' + x), {
                Username: x
            })
                .then(() => {
                    alert("Account Created Successfully")
                })
                .catch((error) => {
                    alert("Unsuccessful");
                    console.log(error);
                })
        }

    function RetData() {
        const dbRef = ref(db);

        get(child(dbRef, 'SpeedRunner/' + Number(i))).then((snapshot) => {
            if (snapshot.exists()) {

                const info1 = document.createElement("span");
                const info2 = document.createElement("span");
                const info3 = document.createElement("span");
                const info4 = document.createElement("span");
                const info5 = document.createElement("span");

                const list = document.createElement("li");
                list.setAttribute("class", "spacing");

                var str = snapshot.val().Run;
                var newStr = str.replace(/_/g, " ");

                list.innerHTML = '<img src="Mega%20Speedruns_files/' + snapshot.val().Tournament + 'SS/' + snapshot.val().Run + '.png"' + snapshot.val().Run + ' alt="' + newStr + '" class="imgResize">' +
                    '<span>Level: ' + newStr + '</span>' + '<span>Category: ' + snapshot.val().Category + '</span>' +
                    '<span>Runner: ' + snapshot.val().Runner + '</span>' + '<span>Time: ' + snapshot.val().Time + '</span>' +
                    '<span><a href=' + snapshot.val().Link + 'target="_blank">Watch Run</a></span>';

                document.getElementById("allSpeedruns").appendChild(list);
            }
            else
                alert("Error");
            console.log(error);
        })
    }

    function DeleteData() {
        remove(ref(db, 'SpeedRunner/' + Link.value))
            .then(() => {
                alert("Data Deleted Successfully")
            })
            .catch((error) => {
                alert("Unsuccessful");
                console.log(error);
            })
    }

    function UpdateData() {
        update(ref(db, 'SpeedRunner/' + Link.value), {
            Runner: { Runner: Runner.value, Link: Link.value, Time: Time.value },
            Run: Run.value,
            Category: Category.value
        })
            .then(() => {
                alert("Data Updated Successfully")
            })
            .catch((error) => {
                alert("Unsuccessful");
                console.log(error);
            })
    }

</script>
</html>