<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User List</title>
<link rel="stylesheet" href="styles.css">
<style>
  body {
    background: url('Mega%20Speedruns_files/bg.png') no-repeat center center fixed;
    background-size: cover;
  }

  .user-list {
    max-width: 600px;
    margin: 50px auto;
    background: rgba(0,0,0,0.6);
    padding: 20px;
    border-radius: 10px;
    color: white;
  }

  .user-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .user-item:hover {
    background: rgba(255,255,255,0.2);
  }

  .user-item img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
  }
</style>
<link rel="shortcut icon" type="image/x-icon" href="Mega%20Speedruns_files/logo.png" />
</head>
<body>
<header>
    <div class="logo">
        <img src="Mega%20Speedruns_files/logo.png" alt="Logo">
    </div>
      <nav class="nav-wrapper">
          <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="MSTLP.htm">Level Packs</a></li>
              <li><a href="MMMLevels.htm">MMM Levels</a></li>
              <li><a href="Speedruns.htm">Speedruns</a></li>
              <li><a id="Forums" href="Forum.html">Forums</a></ali>
              <li><a id="login" href="Login.html">Login</a></li>
              <li><a href="Users.html">Users</a></li>
          </ul>
      </nav>
</header>
<div class="user-list" id="user-list">
  <h1>User List</h1>
  <input 
    type="text" 
    id="search-bar" 
    placeholder="Search for a user..." 
  >
</div>

<style>
  /* Search bar styling */
  #search-bar {
    width: 95%;
    padding: 8px;
    margin: 10px 0 15px 0;
    border-radius: 5px;
    border: 2px solid #444;
    background-color: #222;
    color: #fff;
    font-size: 14px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    outline: none;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* Hover & focus effect */
  #search-bar:focus {
    border-color: orange;
    box-shadow: 0 0 6px orange;
  }

  /* Placeholder color */
  #search-bar::placeholder {
    color: #aaa;
  }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC2pHhSThFkKhN-c1sdhUATt1-zmNLV9sw",
    authDomain: "megaspeedrunsdatabase.firebaseapp.com",
    databaseURL: "https://megaspeedrunsdatabase-default-rtdb.firebaseio.com",
    projectId: "megaspeedrunsdatabase",
    storageBucket: "megaspeedrunsdatabase.appspot.com",
    messagingSenderId: "545413984550",
    appId: "1:545413984550:web:79c899026a21f6343091e7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const loginEl = document.getElementById("login");
  const userListDiv = document.getElementById("user-list");
  const searchInput = document.getElementById("search-bar");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        const snapshot = await get(ref(db, "users/" + user.uid));
        const username = snapshot.val()?.username || "Profile";
        loginEl.textContent = "Profile";
        loginEl.href = "Profile.html";
        localStorage.setItem("username", username);
      } catch (err) {
        console.error("Failed to fetch username:", err);
        loginEl.textContent = "Login";
        loginEl.href = "Login.html";
      }
    } else {
      loginEl.textContent = "Login";
      loginEl.href = "Login.html";
      localStorage.removeItem("username");
    }
  });

  async function loadUsers() {
    try {
      const snapshot = await get(ref(db, 'users'));
      const users = snapshot.val();
      if (!users) {
        userListDiv.innerHTML += "<p>No users found.</p>";
        return;
      }

      // Sort alphabetically
      const sortedUsers = Object.entries(users).sort((a, b) => {
        const usernameA = (a[1].username || "").toLowerCase();
        const usernameB = (b[1].username || "").toLowerCase();
        return usernameA.localeCompare(usernameB);
      });

      // Render users
      sortedUsers.forEach(([uid, user]) => {
        const userItem = document.createElement("div");
        userItem.className = "user-item";

        const usernameColor = user.usernameColor || "#ffffff";
        userItem.innerHTML = `
          <img src="${user.profileImageURL || 'Mega%20Speedruns_files/Default_Avatar.png'}?t=${new Date().getTime()}" alt="${user.username}">
          <span style="color: ${usernameColor};">${user.username}</span>
        `;

        const img = userItem.querySelector("img");
        img.style.border = `3px solid ${usernameColor}`;
        img.style.objectFit = "cover";
        img.onerror = () => {
          img.src = 'Mega%20Speedruns_files/Default_Avatar.png';
        };

        userItem.addEventListener('click', () => {
          window.location.href = `Profile.html?uid=${uid}`;
        });

        userListDiv.appendChild(userItem);
      });

      // Enable search filtering
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        const userItems = document.querySelectorAll(".user-item");

        userItems.forEach(item => {
          const username = item.querySelector("span").textContent.toLowerCase();
          item.style.display = username.includes(query) ? "flex" : "none";
        });
      });
    } catch (err) {
      console.error("Failed to load users:", err);
    }
  }

  loadUsers();
</script>

<script>
window.addEventListener("DOMContentLoaded", () => {
    const loginEl = document.getElementById("login");
    const cachedUsername = localStorage.getItem("username");
    if (cachedUsername) {
        loginEl.textContent = `Profile`;
        loginEl.href = "Profile.html";
    } else {
        loginEl.textContent = "Login";
        loginEl.href = "Login.html";
    }
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            try {
                const snapshot = await db.ref("users/" + user.uid).once("value");
                const username = snapshot.val()?.username || "Login";
                loginEl.textContent = `Profile`;
                loginEl.href = "Profile.html";
                localStorage.setItem("username", username);
            } catch (err) {
                console.error("Failed to fetch username:", err);
                loginEl.textContent = "Login";
                loginEl.href = "Login.html";
            }
        } else {
            loginEl.textContent = "Login";
            loginEl.href = "Login.html";
            localStorage.removeItem("username");
        }
    });
});
</script>
</body>
</html>
